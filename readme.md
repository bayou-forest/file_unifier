# File Unifier

写真などのバックアップや整理のため、2つのフォルダを比較し、重複ファイルを確認・一意に集約するためのデスクトップアプリケーションです。

## 技術スタック

| 項目 | 技術 |
|------|------|
| フレームワーク | Electron 28 |
| フロントエンド | React 18 + TypeScript |
| ビルドツール | electron-vite (Vite 5) |
| パッケージング | electron-builder |
| 対応OS | Windows / macOS |

## 主な機能

### 1. 重複ファイル検索（メイン機能）

2つのフォルダを選択し、含まれるファイルを再帰的にスキャンします。各ファイルのファイルパス・ファイル名・MD5ハッシュ値を取得し、以下6パターンで重複を検出します。

| # | 検出パターン | 説明 |
|---|------------|------|
| 1 | Hash重複 (A内) | フォルダA内でMD5ハッシュが同一のファイル |
| 2 | Hash重複 (B内) | フォルダB内でMD5ハッシュが同一のファイル |
| 3 | Hash重複 (A↔B) | フォルダA/B間でMD5ハッシュが同一のファイル |
| 4 | 名前重複 (A内) | フォルダA内でファイル名が同一のファイル |
| 5 | 名前重複 (B内) | フォルダB内でファイル名が同一のファイル |
| 6 | 名前重複 (A↔B) | フォルダA/B間でファイル名が同一のファイル |

#### 重複ファイルの操作

各重複一覧に対して、以下の操作が可能です。

- **片側を一括削除**: フォルダA側 / フォルダB側 / 各グループの先頭以外を一括選択して削除
- **1つずつ確認**: ダイアログで1グループずつ「どのファイルを残すか」を選択し、まとめて削除を適用
- **ここまで処理する**: 1つずつ確認ダイアログにおいて、先頭から現在表示中のグループまでの決定を適用し、それ以降は処理しない

#### サムネイルプレビュー

重複一覧および確認ダイアログにおいて、画像ファイル・動画ファイルのパスをクリックすると、サムネイルがポップオーバーで表示されます。

対応形式:
- **画像**: jpg, jpeg, png, gif, bmp, webp, tiff, svg, ico, heic, heif, avif
- **動画**: mp4, mov, avi, mkv, wmv, flv, webm, m4v, mpg, mpeg, 3gp, ts

#### スキャンの中断・再開

- スキャン中に「中断」ボタンを押すと、スキャンを途中で停止できます
- 計算済みのファイルパスとMD5ハッシュ値はメモリにキャッシュされます
- 再度スキャンを実行すると、キャッシュ済みファイルのハッシュ計算をスキップし高速に再開します
- キャッシュはアプリの再起動でクリアされます

### 2. ファイルのフラット化（サブ機能）

指定フォルダのサブフォルダ内にある全ファイルを、ルートフォルダ直下に移動します。

- ファイル名が重複して移動できない場合は元の場所に残します
- 移動できなかったファイルパスの一覧を表示します

### 3. 空フォルダの削除（サブ機能）

指定フォルダ配下の空のサブフォルダを再帰的にすべて削除します。ルートフォルダ自体は削除されません。

### 4. 日付別ファイル分類（サブ機能）

指定フォルダを再帰的に探索し、各ファイルの **更新日時(mtime)** に基づいてルートフォルダ直下に `yyyyMMdd_` 形式のフォルダを作成してファイルを移動します。

- 移動先に同名ファイルが既に存在する場合はスキップします
- 既に正しい日付フォルダに存在するファイルは処理をスキップします
- スキップされたファイルパスの一覧を結果として表示します
- 処理中は進捗バーが表示されます

> この機能は `date_picture_sorting_py3.py` と同等の動作を再現しています。

## プロジェクト構成

```
file_unifier/
├── package.json                  # プロジェクト設定・依存関係
├── electron.vite.config.ts       # electron-vite ビルド設定
├── electron-builder.yml          # パッケージング設定
├── tsconfig.json                 # TypeScript設定 (ルート)
├── tsconfig.node.json            # TypeScript設定 (メイン/プリロード)
├── tsconfig.web.json             # TypeScript設定 (レンダラー)
├── resources/                    # アプリアイコン等のリソース
├── src/
│   ├── shared/
│   │   └── types.ts              # 共有型定義
│   ├── main/                     # Electronメインプロセス
│   │   ├── index.ts              # アプリエントリポイント
│   │   ├── fileScanner.ts        # ファイルスキャン・MD5ハッシュ計算・キャッシュ・中断
│   │   ├── fileOperations.ts     # ファイル操作 (削除/フラット化/空フォルダ削除/日付分類/サムネイル)
│   │   └── ipcHandlers.ts       # IPC通信ハンドラ登録
│   ├── preload/                  # プリロードスクリプト
│   │   ├── index.ts              # contextBridge API公開
│   │   └── index.d.ts            # Window型拡張
│   └── renderer/                 # React UIレンダラー
│       ├── index.html            # HTMLエントリポイント
│       └── src/
│           ├── main.tsx          # React エントリポイント
│           ├── App.tsx           # メインアプリコンポーネント (4タブ)
│           ├── App.css           # グローバルスタイル
│           ├── env.d.ts          # Vite環境型定義
│           ├── utils/
│           │   └── duplicateFinder.ts  # 重複検出アルゴリズム
│           └── components/
│               ├── DuplicateFinder.tsx  # 重複検索タブ (中断対応)
│               ├── DuplicateList.tsx    # 重複一覧表示 (サムネイル対応)
│               ├── ResolveDialog.tsx    # 1つずつ確認ダイアログ (ここまで処理+サムネイル)
│               ├── ThumbnailPreview.tsx # サムネイルプレビューコンポーネント
│               ├── FlattenTool.tsx      # フラット化タブ
│               ├── EmptyFolderCleaner.tsx # 空フォルダ削除タブ
│               └── DateSortTool.tsx     # 日付別ファイル分類タブ
├── out/                          # ビルド出力 (git管理外)
└── dist/                         # パッケージ出力 (git管理外)
```

## アーキテクチャ

```
┌──────────────────────────────────────────────────────────┐
│                     Renderer Process                      │
│  (React UI - ユーザー操作・表示・重複検出計算)               │
│                                                            │
│  DuplicateFinder ─── DuplicateList ─── ThumbnailPreview  │
│  FlattenTool         ResolveDialog                        │
│  EmptyFolderCleaner  DateSortTool                         │
│  duplicateFinder (utils)                                  │
└─────────────┬────────────────────────────────────────────┘
              │ IPC (contextBridge)
┌─────────────┴────────────────────────────────────────────┐
│                      Main Process                         │
│  (ファイルI/O - スキャン・削除・移動・分類・サムネイル)       │
│                                                            │
│  fileScanner.ts (キャッシュ・中断対応)                      │
│  fileOperations.ts (日付分類・サムネイル生成)                │
│  ipcHandlers.ts                                           │
└──────────────────────────────────────────────────────────┘
```

- **メインプロセス**: ファイルI/O操作（スキャン、MD5計算+キャッシュ、削除、移動、日付分類、サムネイル生成）
- **レンダラープロセス**: UI表示と重複検出の純粋な計算ロジック
- **IPC通信**: contextBridge経由で安全にAPIを公開

## セットアップ・開発

### 前提条件

- Node.js 18以上
- npm 9以上

### インストール

```bash
npm install
```

### 開発モードで起動

```bash
npm run dev
```

ホットリロード対応で、コード変更が即座に反映されます。

### プロダクションビルド

```bash
npm run build
```

### パッケージング（インストーラ生成）

```bash
# Windows (NSIS インストーラ)
npm run package:win

# macOS (DMG)
npm run package:mac

# 現在のOS向け
npm run package
```

生成されたインストーラは `dist/` ディレクトリに出力されます。

### アプリアイコンの設定

パッケージングの際にアプリアイコンを設定するには、以下のファイルを `resources/` ディレクトリに配置してください。

- Windows: `icon.ico` (256x256以上)
- macOS: `icon.icns`

## 使い方

### 重複ファイル検索

1. 「重複ファイル検索」タブを選択
2. 「参照...」ボタンでフォルダA（必須）とフォルダB（任意）を選択
3. 「スキャン開始」をクリック（進捗バーが表示されます）
   - スキャン中に「中断」ボタンで途中停止が可能（キャッシュ済みのため再開が高速）
4. スキャン完了後、6つのサブタブで重複結果を確認
   - 画像/動画ファイルはパスクリックでサムネイルプレビュー表示
5. 重複を解消するには：
   - **一括操作**: 「フォルダA側を全選択」等で選択後「選択を削除」
   - **個別確認**: 「1つずつ確認」で各グループごとに残すファイルを選択
   - **途中まで適用**: 「ここまで処理する」で現在表示中のグループまでを適用

### フラット化

1. 「フラット化」タブを選択
2. 対象フォルダを選択
3. 「フラット化実行」をクリック
4. 結果と移動できなかったファイル一覧を確認

### 空フォルダ削除

1. 「空フォルダ削除」タブを選択
2. 対象フォルダを選択
3. 「空フォルダを削除」をクリック
4. 削除されたフォルダ数を確認

### 日付別ファイル分類

1. 「日付分類」タブを選択
2. 対象フォルダを選択
3. 「日付分類を実行」をクリック（進捗バーが表示されます）
4. ファイルの更新日時に基づき `yyyyMMdd_` フォルダへ自動分類
5. 移動結果とスキップされたファイル一覧を確認

## ライセンス

MIT
